<div class="menu">
  <button onclick="launchWebamp()" class="menu">
    <strong>Launch webamp player</strong>
    <img src="/webamp/webamp.svg" alt="Webamp logo" style="height: 1.5em; vertical-align: middle;">
  </button>
</div>

<div id="app" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none;">
  <!-- Webamp will attempt to center itself within this div -->
</div>

<script src="https://unpkg.com/webamp@1.5.0/built/webamp.bundle.min.js"></script>
<script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurn.min.js"></script>
<script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js"></script>
<script>
  const Webamp = window.Webamp;
  {{ $tracks := .Page.Resources.GetMatch (.Get "tracks" | default "tracks.yaml") | transform.Unmarshal }}
  let webampInstance = null;

  function launchWebamp() {
    if (webampInstance) {
      webampInstance.dispose();
      webampInstance = null;
    }

    webampInstance = new Webamp({
      initialTracks: {{ $tracks | jsonify | safeJS }},
      __butterchurnOptions: {
        importButterchurn: () => Promise.resolve(window.butterchurn),
        getPresets: () => {
          const presets = window.butterchurnPresets.getPresets();
          return Object.keys(presets).map((name) => {
            return {
              name,
              butterchurnPresetObject: presets[name],
            };
          });
        },
        butterchurnOpen: true,
      },
      __initialWindowLayout: {
        main: { position: { x: 0, y: 0 } },
        equalizer: { 
          position: { x: 0, y: 116 }
        },
        playlist: {
          position: { x: 0, y: 130 },
          size: [0, 1]
        },
        milkdrop: {
          position: { x: 0, y: 275 },
          size: [0,2]
        }
      }
    });
    
    const appElement = document.getElementById("app");
    appElement.style.display = "block";

    // Add touch event handlers
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    function handleTouchStart(e) {
      initialX = e.touches[0].clientX - xOffset;
      initialY = e.touches[0].clientY - yOffset;
      
      if (e.target.closest(".window")) {
        isDragging = true;
      }
    }

    function handleTouchMove(e) {
      if (isDragging) {
        e.preventDefault();
        currentX = e.touches[0].clientX - initialX;
        currentY = e.touches[0].clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        
        const windows = document.querySelectorAll(".window");
        windows.forEach(window => {
          window.style.transform = `translate(${currentX}px, ${currentY}px)`;
        });
      }
    }

    function handleTouchEnd() {
      isDragging = false;
    }

    webampInstance.renderWhenReady(appElement).then(() => {
      // Add touch event listeners
      appElement.addEventListener("touchstart", handleTouchStart, false);
      appElement.addEventListener("touchmove", handleTouchMove, false);
      appElement.addEventListener("touchend", handleTouchEnd, false);
      
      // Minimize (shade) the equalizer
      webampInstance.store.dispatch({ type: 'TOGGLE_WINDOW_SHADE_MODE', windowId: 'equalizer' });
      
      webampInstance.onClose(() => {
        appElement.style.display = "none";
        // Remove touch event listeners
        appElement.removeEventListener("touchstart", handleTouchStart);
        appElement.removeEventListener("touchmove", handleTouchMove);
        appElement.removeEventListener("touchend", handleTouchEnd);
        webampInstance.dispose();
        webampInstance = null;
      });
    });
  }
</script> 