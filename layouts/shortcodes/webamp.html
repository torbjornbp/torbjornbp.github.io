<div class="menu">
  <button onclick="initWebamp()" class="menu">
    <strong>Launch webamp player</strong>
    <img src="/webamp/webamp.svg" alt="Webamp logo" style="height: 1.5em; vertical-align: middle;">
  </button>
</div>

<div id="app" style="height: 100vh; position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none;">
  <!-- Webamp will attempt to center itself within this div -->
</div>

<script>
  {{ $tracks := .Page.Resources.GetMatch (.Get "tracks" | default "tracks.yaml") | transform.Unmarshal }}
  let webampInstance = null;

  async function loadScript(url) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = url;
      script.onload = resolve;
      script.onerror = reject;
      document.body.appendChild(script);
    });
  }

  async function initWebamp() {
    if (webampInstance) {
      launchWebamp();
      return;
    }

    try {
      await Promise.all([
        loadScript('https://unpkg.com/webamp@1.5.0/built/webamp.bundle.min.js'),
        loadScript('https://unpkg.com/butterchurn@2.6.7/lib/butterchurn.min.js'),
        loadScript('https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js')
      ]);
      
      launchWebamp();
    } catch (error) {
      console.error('Failed to load Webamp dependencies:', error);
    }
  }

  function launchWebamp() {
    if (webampInstance) {
      webampInstance.dispose();
      webampInstance = null;
    }

    const webampOptions = {
      initialTracks: {{ $tracks | jsonify | safeJS }},
      __butterchurnOptions: {
        importButterchurn: () => Promise.resolve(window.butterchurn),
        getPresets: () => {
          const presets = window.butterchurnPresets.getPresets();
          return Object.keys(presets).map((name) => {
            return {
              name,
              butterchurnPresetObject: presets[name],
            };
          });
        },
        butterchurnOpen: true,
      },
      __initialWindowLayout: {
        main: { position: { x: 0, y: 0 } },
        equalizer: { 
          position: { x: 0, y: 116 }
        },
        playlist: {
          position: { x: 0, y: 130 },
          size: [0, 1]
        },
        milkdrop: {
          position: { x: 0, y: 275 },
          size: [0,2]
        }
      }
    };

    webampInstance = new Webamp(webampOptions);
    
    const app = document.getElementById("app");
    app.style.display = "block";
    
    // Ensure mobile Safari plays nice with touch events
    app.addEventListener('touchmove', function(e) {
      e.preventDefault();
    }, { passive: false });

    webampInstance.renderWhenReady(app).then(() => {
      // Minimize (shade) the equalizer
      webampInstance.store.dispatch({ type: 'TOGGLE_WINDOW_SHADE_MODE', windowId: 'equalizer' });
      
      webampInstance.onClose(() => {
        app.style.display = "none";
        webampInstance.dispose();
        webampInstance = null;
      });
    });
  }
</script> 